---
title: Appendix
metaTitle: Appendix
metaDescription: description
---

<div class="index">

supported failover scenarios

</div>

## Appendix A: Supported Failover Scenarios

A summary of supported failover scenarios is provided below. Please note
that the list is not comprehensive; you should consult the Failover
Manager documentation for detailed information about how Failover
Manager handles each failover/failure scenario.

<div class="tabularcolumns">

Y{0.7}|

</div>

| **Scenario**                                       | **Failover Manager/pgPool Response**                                                                                                                                                                                                                                                                                                                                                          |
| -------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Master Database is Down                            | In most cases, Failover Manager will perform a failover, promoting one of the available standbys into a master node. Virtual IP addresses (if configured) will be re-assigned.                                                                                                                                                                                                                |
| Master agent crashes or master node fails          | To prevent premature failover/promotion, Failover Manager will first check to see if the master database is still in service (i.e., only the EFM agent on the master server is down, not the entire machine). If necessary, EFM will subsequently perform a failover by promoting one of the available standbys into a master node. Virtual IP addresses (if configured) will be re-assigned. |
| Standby agent exits or standby node fails          | Failover Manager will notify the administrator and invoke the load_balancer_detach.sh script (when properly configured in efm.properties). For more information, see                                                                                                                                                                                                                        |
| \`load_balancer_detach.sh \<load_balancer_deta | ch.sh\>\`_ in Appendix B.                                                                                                                                                                                                                                                                                                                                                                    |
| Dedicated witness agent exits or node fails        | EFM: Administrator is notified Pgpool: Pgpool will perform a failover and an existing standby PgPool instance will be promoted as the active instance. Virtual IP (if configured) will be re-assigned to new active instance.                                                                                                                                                                 |
| Standby gets added back to cluster                 | When a standby node comes back up, it gets added back to the Failover Manager cluster by use of the `efm resume <clustername>` command. The `load_balancer_attach.sh` script is subsequently called (when properly configured), and updates the Pgpool cluster via the PCP interface. For more information, see                                                                               |
| \`load_balancer_attach.sh \<load_balancer_atta | ch.sh\>\`_ in Appendix B.                                                                                                                                                                                                                                                                                                                                                                    |

## Appendix B: Integration Scripts

<div class="index">

integration scripts

</div>

### load_balancer_detach.sh

<div id="load_balancer_detach.sh">

<div class="index">

load_balancer_detach.sh

</div>

</div>

``` text
#!/bin/bash
#%h host name
output_file=/tmp/efm-scripts/pp_log
pool_backend=/tmp/efm-scripts/pgpool/pgpool_backend.sh
node_address=$1
current_date_time="`date +"%Y-%m-%d %H:%M:%S"`";
echo $current_date_time >>$output_file
echo "node address to detach = $node_address". >>$output_file
$pool_backend detach $node_address >>$output_file
echo "-------------------".>>$output_file
exit 0
```

### load_balancer_attach.sh

<div id="load_balancer_attach.sh">

<div class="index">

load_balancer_attach.sh

</div>

</div>

``` text
#!/bin/bash
#%h host name
output_file=/tmp/efm-scripts/pp_log
pool_backend=/tmp/efm-scripts/pgpool/pgpool_backend.sh
node_address=$1
current_date_time="`date +"%Y-%m-%d %H:%M:%S"`";
echo $current_date_time >>$output_file
echo "node address to attach = $node_address". >>$output_file
$pool_backend attach $1 >>$output_file
echo "-------------------".>>$output_file
exit 0
```

### follow_master.sh

<div class="index">

follow_master.sh

</div>

``` text
#! /bin/sh
PCP_USER= # PCP user name
PCP_PORT= # PCP port number as in pgpool.conf
PCP_HOST= # hostname of Pgpool-II
PGPOOL_PATH= # Pgpool-II installed path
export PCPPASSFILE= # Path to PCPPASS file
---
title: Execute command by failover.
metaTitle: Execute command by failover.
metaDescription: description
---
---
title: special values: %d = node id
metaTitle: special values: %d = node id
metaDescription: description
---
---
title: %h = host name
metaTitle: %h = host name
metaDescription: description
---
---
title: %p = port number
metaTitle: %p = port number
metaDescription: description
---
---
title: %D = database cluster path
metaTitle: %D = database cluster path
metaDescription: description
---
---
title: %m = new master node id
metaTitle: %m = new master node id
metaDescription: description
---
---
title: %M = old master node id
metaTitle: %M = old master node id
metaDescription: description
---
---
title: %H = new master node host name
metaTitle: %H = new master node host name
metaDescription: description
---
---
title: %P = old primary node id
metaTitle: %P = old primary node id
metaDescription: description
---
---
title: %R = new master database cluster path
metaTitle: %R = new master database cluster path
metaDescription: description
---
---
title: %r = new master port number
metaTitle: %r = new master port number
metaDescription: description
---
---
title: %% = '%' character
metaTitle: %% = '%' character
metaDescription: description
---
detached_node_id=$1
old_master_id=$2
echo detached_node_id $1
echo old_master_id $2
## If $detached_node_id is equal to $old_master_id,
## then do nothing, since the old master is no longer
## supposed to be part of the cluster.
if [ $detached_node_id -ne $old_master_id ]; then
sleep 10
$PGPOOL_PATH/pcp_attach_node -w -U $PCP_USER -h $PCP_HOST -p
$PCP_PORT $detached_node_id
fi
```

### pgpool_backend.sh

<div class="index">

pgpool_backend.sh

</div>

``` text
#!/bin/bash
#
---
title: pgpool-II backend node configuration driver.
metaTitle: pgpool-II backend node configuration driver.
metaDescription: description
---
#
---
title: usage: promote_standby.sh hostname [port]
metaTitle: usage: promote_standby.sh hostname [port]
metaDescription: description
---
#
---
title: set the following variables according to your setup
metaTitle: set the following variables according to your setup
metaDescription: description
---
PCP_USER= # PCP user name
PCP_PORT= # PCP port number as in pgpool.conf
PCP_HOST= # hostname of Pgpool-II
PGPOOL_PATH= # Pgpool-II installed path
export PCPPASSFILE= # Path to PCPPASS file
---
title: function returns the Pgpool-II backend node-id for the given
metaTitle: function returns the Pgpool-II backend node-id for the given
metaDescription: description
---
hostname
---
title: and port number, And if the node-id is not found 255 is returned
metaTitle: and port number, And if the node-id is not found 255 is returned
metaDescription: description
---
---
title: Arguments:
metaTitle: Arguments:
metaDescription: description
---
---
title: 1- Hostname
metaTitle: 1- Hostname
metaDescription: description
---
---
title: 2- Port (optional) if not provided, node-id of first matching
metaTitle: 2- Port (optional) if not provided, node-id of first matching
metaDescription: description
---
---
title: hostname will be returned
metaTitle: hostname will be returned
metaDescription: description
---
#
function get_pgpool_nodeid_from_host {
if [ -z "$1" ]; then
echo "hostname not provided"
return 255
fi
#Now get the total number of nodes configured in Pgpool-II
node_count=`$PGPOOL_PATH/pcp_node_count -U $PCP_USER -h $PCP_HOST -p
$PCP_PORT -w\`
echo searching node-id for $1:$2 from $node_count configured backends
i=0
while [ $i -lt $node_count ];
do
nodeinfo=`$PGPOOL_PATH/pcp_node_info -U $PCP_USER -h $PCP_HOST -p
$PCP_PORT -w $i\`
hostname=`echo $nodeinfo \| awk -v N=1 '{print $N}'\`
port=`echo $nodeinfo \| awk -v N=2 '{print $N}'\`
#if port number is <= 0 we just need to compare hostname
if [ "$hostname" == $1 ] && ( [ -z "$2" ] \|\| [ $port -eq $2 ] );
then
echo "$1:$2 has backend node-id = $i in Pgpool-II"
return $i
fi
let i=i+1
done
return 255
}
---
title: function returns 1 if Pgpool-II backend node for the given hostname
metaTitle: function returns 1 if Pgpool-II backend node for the given hostname
metaDescription: description
---
---
title: and port number is the primary node in Pgpool-II
metaTitle: and port number is the primary node in Pgpool-II
metaDescription: description
---
---
title: returns 0 for the standby node and 255 if no node exist for the
metaTitle: returns 0 for the standby node and 255 if no node exist for the
metaDescription: description
---
hostname
---
title: Arguments:
metaTitle: Arguments:
metaDescription: description
---
---
title: 1- Hostname
metaTitle: 1- Hostname
metaDescription: description
---
---
title: 2- Port (optional) if not provided, node-id of first matching
metaTitle: 2- Port (optional) if not provided, node-id of first matching
metaDescription: description
---
---
title: hostname will be returned
metaTitle: hostname will be returned
metaDescription: description
---
#
function is_host_is_primary_pgpool_node {
if [ -z "$1" ]; then
echo "hostname not provided"
return 255
fi
#Now get the total number of nodes configured in Pgpool-II
node_count=`$PGPOOL_PATH/pcp_node_count -U $PCP_USER -h $PCP_HOST -p
$PCP_PORT -w\`
echo searching node-id for $1:$2 from $node_count configured backends
i=0
while [ $i -lt $node_count ];
do
nodeinfo=`$PGPOOL_PATH/pcp_node_info -U $PCP_USER -h $PCP_HOST -p
$PCP_PORT -w $i\`
hostname=`echo $nodeinfo \| awk -v N=1 '{print $N}'\`
port=`echo $nodeinfo \| awk -v N=2 '{print $N}'\`
role=`echo $nodeinfo \| awk -v N=6 '{print $N}'\`
#if port numbner is <= 0 we just need to compare hostname
if [ "$hostname" == $1 ] && ( [ -z "$2" ] \|\| [ $port -eq $2 ] );
then
echo "$1:$2 has backend node-id = $i in Pgpool-II"
---
title: check if the node role is primary
metaTitle: check if the node role is primary
metaDescription: description
---
if [ "$role" == "primary" ]; then
return 1
else
return 0
fi
fi
let i=i+1
done
return 255
}
---
title: Function promotes the node-id to the new master node
metaTitle: Function promotes the node-id to the new master node
metaDescription: description
---
---
title: Arguments:
metaTitle: Arguments:
metaDescription: description
---
---
title: 1- node-id: Pgpool-II backend node-id of node to be promoted to
metaTitle: 1- node-id: Pgpool-II backend node-id of node to be promoted to
metaDescription: description
---
master
function promote_node_id_to_master {
if [ -z "$1" ]; then
echo "node-id not provided"
return 255
fi
$PGPOOL_PATH/pcp_promote_node -w -U $PCP_USER -h $PCP_HOST -p
$PCP_PORT $1
return $?
}
---
title: Function attach the node-id to the Pgpool-II
metaTitle: Function attach the node-id to the Pgpool-II
metaDescription: description
---
---
title: Arguments
metaTitle: Arguments
metaDescription: description
---
---
title: 1- node-id: Pgpool-II backend node-id to be attached
metaTitle: 1- node-id: Pgpool-II backend node-id to be attached
metaDescription: description
---
function attach_node_id {
if [ -z "$1" ]; then
echo "node-id not provided"
return 255
fi
$PGPOOL_PATH/pcp_attach_node -w -U $PCP_USER -h $PCP_HOST -p
$PCP_PORT $1
return $?
}
---
title: Function detach the node-id from the Pgpool-II
metaTitle: Function detach the node-id from the Pgpool-II
metaDescription: description
---
---
title: Arguments
metaTitle: Arguments
metaDescription: description
---
---
title: 1- node-id: Pgpool-II backend node-id to be detached
metaTitle: 1- node-id: Pgpool-II backend node-id to be detached
metaDescription: description
---
function detach_node_id {
if [ -z "$1" ]; then
echo "node-id not provided"
return 255
fi
$PGPOOL_PATH/pcp_detach_node -w -U $PCP_USER -h $PCP_HOST -p
$PCP_PORT $1
return $?
}
---
title: function promotes the standby node identified by hostname:port
metaTitle: function promotes the standby node identified by hostname:port
metaDescription: description
---
---
title: to the master node in Pgpool-II
metaTitle: to the master node in Pgpool-II
metaDescription: description
---
---
title: Arguments:
metaTitle: Arguments:
metaDescription: description
---
---
title: 1- Hostname
metaTitle: 1- Hostname
metaDescription: description
---
---
title: 2- Port (optional) if not provided, node-id of first matching
metaTitle: 2- Port (optional) if not provided, node-id of first matching
metaDescription: description
---
---
title: hostname will be promoted
metaTitle: hostname will be promoted
metaDescription: description
---
#
function promote_standby_to_master {
get_pgpool_nodeid_from_host $1 $2
node_id=$?
if [ $node_id -eq 255 ]; then
echo unable to find Pgpool-II backend node id for $1:$2
return 255
else
echo promoting node-id: $node_id to master
promote_node_id_to_master $node_id
return $?
fi
}
---
title: function attaches the backend node identified by hostname:port
metaTitle: function attaches the backend node identified by hostname:port
metaDescription: description
---
---
title: to Pgpool-II
metaTitle: to Pgpool-II
metaDescription: description
---
---
title: Arguments:
metaTitle: Arguments:
metaDescription: description
---
---
title: 1- Hostname
metaTitle: 1- Hostname
metaDescription: description
---
---
title: 2- Port (optional) if not provided, node-id of first matching
metaTitle: 2- Port (optional) if not provided, node-id of first matching
metaDescription: description
---
---
title: hostname will be promoted
metaTitle: hostname will be promoted
metaDescription: description
---
#
function attach_node {
get_pgpool_nodeid_from_host $1 $2
node_id=$?
if [ $node_id -eq 255 ]; then
echo unable to find Pgpool-II backend node id for $1:$2
return 255
else
echo attaching node-id: $node_id to Pgpool-II
attach_node_id $node_id
return $?
fi
}
---
title: function detaches the backend node identified by hostname:port
metaTitle: function detaches the backend node identified by hostname:port
metaDescription: description
---
---
title: from Pgpool-II
metaTitle: from Pgpool-II
metaDescription: description
---
---
title: Arguments:
metaTitle: Arguments:
metaDescription: description
---
---
title: 1- Hostname
metaTitle: 1- Hostname
metaDescription: description
---
---
title: 2- Port (optional) if not provided, node-id of first matching
metaTitle: 2- Port (optional) if not provided, node-id of first matching
metaDescription: description
---
---
title: hostname will be promoted
metaTitle: hostname will be promoted
metaDescription: description
---
#
function detach_node {
get_pgpool_nodeid_from_host $1 $2
node_id=$?
if [ $node_id -eq 255 ]; then
echo unable to find Pgpool-II backend node id for $1:$2
return 255
else
echo detaching node-id: $node_id from Pgpool-II
detach_node_id $node_id
return $?
fi
}
function print_usage {
echo "usage:"
echo " $(basename $0) operation hostname [port]".
echo " operations:".
echo " check_primary: check if node has a primary role".
echo " promote: promote node".
echo " attach: attach node".
echo " detach: detach node".
}
---
title: script entry point
metaTitle: script entry point
metaDescription: description
---
if [ -z "$1" ] \|\| [ -z "$2" ]; then
echo "ERROR: operation not provided"
print_usage
exit 1
fi
shopt -s nocasematch
case "$1" in
"check_primary" )
is_host_is_primary_pgpool_node $2 $3
;;
"promote" ) echo "promote"
promote_standby_to_master $2 $3
;;
"attach" ) echo "attach"
attach_node $2 $3;;
"detach" ) echo "detach"
detach_node $2 $3;;
"watchdog" ) echo "detach"
$PGPOOL_PATH/pcp_watchdog_info -w -U $PCP_USER -h $PCP_HOST -p
$PCP_PORT -v;;
*) echo "invalid operation $1".
print_usage;;
esac
exit $?
```
